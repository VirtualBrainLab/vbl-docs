<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sensapex Link &mdash; Virtual Brain Lab 0.1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Development" href="05_tp_development.html" />
    <link rel="prev" title="Electrophysiology Atlas" href="03_tp_ephys_atlas.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Virtual Brain Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About the VBL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../01_about/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_about/team.html">Team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_about/joinus.html">Join Us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Trajectory Planner</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_tp_intro.html">Installation and Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_tp_alignment.html">Allen CCF to In Vivo Alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_tp_ephys_atlas.html">Electrophysiology Atlas</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sensapex Link</a></li>
<li class="toctree-l1"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#for-usage-like-a-standalone-app-server">For usage like a standalone app/server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#for-usage-like-a-library">For usage like a library</a></li>
<li class="toctree-l2"><a class="reference internal" href="#to-develop-this-package">To develop this package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#registering-a-manipulator">Registering a manipulator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#get-a-manipulator-s-position">Get a manipulator’s position</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-position-of-a-manipulator">Set position of a manipulator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#code-organization">Code Organization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#server-py"><code class="docutils literal notranslate"><span class="pre">server.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#sensapex-handler-py"><code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#manipulator-py"><code class="docutils literal notranslate"><span class="pre">manipulator.py</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#general-code-practices-for-developers-looking-to-contribute">General code practices (for developers looking to contribute)</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_tp_development.html">Development</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unity Renderer for Neuroscience</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../03_unity_neuro/01_urn_intro.html">Installation and Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_unity_neuro/02_urn_development.html">Development</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Session Viewer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../04_session_viewer/01_sv_overview.html">Session Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_session_viewer/02_ibl_average_trial.html">IBL Average Trial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../05_misc/01_vbl_core.html">VBL Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_misc/02_addressables_storage.html">Addressables Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_misc/03_general_dev.html">General Programming Advice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_misc/04_unity_tutorials.html">Unity</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Virtual Brain Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Sensapex Link</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/02_traj_planner/04_sensapex_link.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sensapex-link">
<h1>Sensapex Link<a class="headerlink" href="#sensapex-link" title="Permalink to this heading"></a></h1>
<p>The Sensapex Link is a python server that allows any WebSocket compliant application (such as <a class="reference external" href="https://github.com/dbirman/NPTrajectoryPlanner/">Pinpoint (Neuropixels Trajectory Planner)</a>) to have limited communication with <a class="reference external" href="https://www.sensapex.com/products/ump-micromanipulators/">Sensapex uMp Micromanipulators</a></p>
<p><strong>Table of Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#installation"><span class="std std-ref">Installation</span></a></p></li>
<li><p><a class="reference internal" href="#usage"><span class="std std-ref">Usage</span></a></p></li>
<li><p><a class="reference internal" href="#code-organization"><span class="std std-ref">Code Organization</span></a></p></li>
</ul>
</section>
<section id="installation">
<span id="id1"></span><h1>Installation<a class="headerlink" href="#installation" title="Permalink to this heading"></a></h1>
<p>Copied from the <a class="reference external" href="https://github.com/dbirman/nptraj-sensapex-link/blob/main/README.md">repo’s README.md</a></p>
<section id="for-usage-like-a-standalone-app-server">
<h2>For usage like a standalone app/server<a class="headerlink" href="#for-usage-like-a-standalone-app-server" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Ensure Python 3.8+ and pip are installed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">nptraj-sensapex-link</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">nptraj-sensapex-link</span></code> to start the server</p></li>
</ol>
</section>
<section id="for-usage-like-a-library">
<h2>For usage like a library<a class="headerlink" href="#for-usage-like-a-library" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Ensure Python 3.8+ and pip are installed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">nptraj-sensapex-link</span></code></p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">nptraj_sensapex_link</span> <span class="pre">import</span> <span class="pre">launch</span></code> and call <code class="docutils literal notranslate"><span class="pre">launch()</span></code> to start the server</p>
<ol class="arabic simple">
<li><p>Alternatively, use <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">nptraj_sensapex_link</span></code> and call <code class="docutils literal notranslate"><span class="pre">nptraj_sensapex_link.launch()</span></code></p></li>
</ol>
</li>
</ol>
</section>
<section id="to-develop-this-package">
<h2>To develop this package<a class="headerlink" href="#to-develop-this-package" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Ensure Python 3.8+ and pip are installed</p></li>
<li><p>Clone the <a class="reference external" href="https://github.com/dbirman/nptraj-sensapex-link">repo</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">nptraj-sensapex-link</span></code> and run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code></p></li>
<li><p>The package is located in <code class="docutils literal notranslate"><span class="pre">src/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">src/nptraj_sensapex_link/server.py</span></code> launches the server</p></li>
<li><p>Unit tests are available to run under the <code class="docutils literal notranslate"><span class="pre">tests/</span></code> directory</p></li>
</ol>
</section>
</section>
<section id="usage">
<span id="id2"></span><h1>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h1>
<p>This is a list of available WebSocket events. The code shown is pseudo-WebSocket code that can be used to interact with the server. The exact implementation will depend on the platform and WebSocket interface used.</p>
<p>In general, each event will take in an input and call a callback function with certain arguments.</p>
<p><strong>Table of Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#registering-a-manipulator"><span class="std std-ref">Registering a manipulator</span></a></p></li>
<li><p><a class="reference internal" href="#get-a-manipulators-position"><span class="std std-ref">Get a manipulator’s position</span></a></p></li>
<li><p><a class="reference internal" href="#set-position-of-a-manipulator"><span class="std std-ref">Set position of a manipulator</span></a></p></li>
</ul>
<section id="registering-a-manipulator">
<span id="id3"></span><h2>Registering a manipulator<a class="headerlink" href="#registering-a-manipulator" title="Permalink to this heading"></a></h2>
<p>Every manipulator in a Sensapex setup must be registered to the server before being used.</p>
<p><strong>Event:</strong> <code class="docutils literal notranslate"><span class="pre">register_manipulator</span></code></p>
<p><strong>Expected Arguments:</strong></p>
<ul class="simple">
<li><p>Manipulator ID: <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
</ul>
<p><strong>Callback Responses <code class="docutils literal notranslate"><span class="pre">(int,</span> <span class="pre">string)</span></code>:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">'')</span></code>: No errors, registered manipulator with ID <code class="docutils literal notranslate"><span class="pre">manipulator_id</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">'Manipulator</span> <span class="pre">already</span> <span class="pre">registered')</span></code>: Manipulator is already registered, no action taken</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">'Manipulator</span> <span class="pre">not</span> <span class="pre">found')</span></code>: The manipulator is not discoverable by the API and may be disconnected or offline</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">'Error</span> <span class="pre">registering</span> <span class="pre">manipulator')</span></code>: An unknown error has occurred while getting position</p></li>
</ul>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Register manipulator with ID 1</span>
<span class="n">ws</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;register_manipulator&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">my_callback_func</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="get-a-manipulator-s-position">
<span id="get-a-manipulators-position"></span><h2>Get a manipulator’s position<a class="headerlink" href="#get-a-manipulator-s-position" title="Permalink to this heading"></a></h2>
<p>Receive the position of a specified manipulator as X, Y, Z, W (depth) in µm from the origin.</p>
<p><strong>Event:</strong> <code class="docutils literal notranslate"><span class="pre">get_pos</span></code></p>
<p><strong>Expected Arguments:</strong></p>
<ul class="simple">
<li><p>Manipulator ID: <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
</ul>
<p><strong>Callback Responses <code class="docutils literal notranslate"><span class="pre">(int,</span> <span class="pre">float[4],</span> <span class="pre">string)</span></code></strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">(x,</span> <span class="pre">y,</span> <span class="pre">z,</span> <span class="pre">w),</span> <span class="pre">'')</span></code>: No errors, position is returned</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">(),</span> <span class="pre">'Manipulator</span> <span class="pre">not</span> <span class="pre">registered')</span></code>: Manipulator is not registered yet</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">(),</span> <span class="pre">'Error</span> <span class="pre">getting</span> <span class="pre">position')</span></code>: An unknown error has occured while getting position</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gets the position of manipulator 1</span>
<span class="n">ws</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;get_pos&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">my_callback_func</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="set-position-of-a-manipulator">
<span id="id4"></span><h2>Set position of a manipulator<a class="headerlink" href="#set-position-of-a-manipulator" title="Permalink to this heading"></a></h2>
<p>Instructs a manipulator to go to a position relative to the origin in µm. The manipulator will travel to the given positions in the order the server receives them. All movement is sequential and the handler for this event is blocked while a movement is taking place.</p>
<p><strong>Event:</strong> <code class="docutils literal notranslate"><span class="pre">goto_pos</span></code></p>
<p><strong>Expected Arguments (dictionary/object with the following format):</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">manipulator_id</span></code>: <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pos</span></code>: <code class="docutils literal notranslate"><span class="pre">float[4]</span></code> (in x, y, z, w as µm from the origin)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">speed</span></code>: <code class="docutils literal notranslate"><span class="pre">int</span></code> (in µm/s)</p></li>
</ul>
<p><strong>Callback Responses <code class="docutils literal notranslate"><span class="pre">(int,</span> <span class="pre">float[4],</span> <span class="pre">string)</span></code></strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">(x,</span> <span class="pre">y,</span> <span class="pre">z,</span> <span class="pre">w),</span> <span class="pre">'')</span></code>: No errors, final position is returned</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">(),</span> <span class="pre">'Manipulator</span> <span class="pre">not</span> <span class="pre">registered')</span></code>: Manipulator is not registered yet</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(manipulator_id,</span> <span class="pre">(),</span> <span class="pre">'Error</span> <span class="pre">moving</span> <span class="pre">manipulator')</span></code>: An unknown error has occured while getting position</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set manipulator 1 to position 0, 0, 0, 0 at 2000 µm/s</span>
<span class="n">ws</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;goto_pos&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;manipulator_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;speed&#39;</span><span class="p">:</span> <span class="mi">2000</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="code-organization">
<span id="id5"></span><h1>Code Organization<a class="headerlink" href="#code-organization" title="Permalink to this heading"></a></h1>
<p>There are three main components of this package:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">server.py</span></code>: The main server code</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code>: Code for communicating with the Sensapex API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">manipulator.py</span></code>: A class for representing a manipulator</p></li>
</ol>
<section id="server-py">
<h2><code class="docutils literal notranslate"><span class="pre">server.py</span></code><a class="headerlink" href="#server-py" title="Permalink to this heading"></a></h2>
<p>All code responsible for WebSocket server functionality is in this file. This includes client connection/disconnection, event handling, and the main server loop.</p>
<p>For every event, the server does the following:</p>
<ol class="arabic simple">
<li><p>Extract the arguments passed in the event</p></li>
<li><p>Log that the event was received</p></li>
<li><p>Call the appropriate function in <code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code> with the arguments</p></li>
<li><p>Call the callback function with the response from <code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code> as parameters</p></li>
</ol>
</section>
<section id="sensapex-handler-py">
<h2><code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code><a class="headerlink" href="#sensapex-handler-py" title="Permalink to this heading"></a></h2>
<p>All code responsible for communicating with the Sensapex API is in this file. This loading the DLL, establishing a connection with the equipment and maintaining a dictionary of registered manipulators.</p>
<p>Functions names here are the same as the WebSocket events. They are called when the server receives an event from a client. In general, the function does the following:</p>
<ol class="arabic simple">
<li><p>Recieve extracted arguments from <code class="docutils literal notranslate"><span class="pre">server.py</span></code></p></li>
<li><p>Inside try/except block, call the appropriate Sensapex API function</p></li>
<li><p>Log/handle successes and failures</p></li>
<li><p>Return the callback parameters to <code class="docutils literal notranslate"><span class="pre">server.py</span></code></p></li>
</ol>
</section>
<section id="manipulator-py">
<h2><code class="docutils literal notranslate"><span class="pre">manipulator.py</span></code><a class="headerlink" href="#manipulator-py" title="Permalink to this heading"></a></h2>
<p>To help make calling functions on manipulators easier, a custom class containing the necessary functions and flags is created. This class is used by <code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code> to call manipulator-specific APIs such as <code class="docutils literal notranslate"><span class="pre">get_pos</span></code> (get position) and to keep track of manipulator-specific flags such as if it has been calibrated yet.</p>
<p>Manipulator functions handle errors and return the appropriate callback parameters like in <code class="docutils literal notranslate"><span class="pre">sensapex_handler.py</span></code>.</p>
</section>
</section>
<section id="general-code-practices-for-developers-looking-to-contribute">
<h1>General code practices (for developers looking to contribute)<a class="headerlink" href="#general-code-practices-for-developers-looking-to-contribute" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p>Type hinting is implemented where possible</p></li>
<li><p>Tuples are used when possible</p></li>
<li><p>Only one client can be connected at a time</p></li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_tp_ephys_atlas.html" class="btn btn-neutral float-left" title="Electrophysiology Atlas" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05_tp_development.html" class="btn btn-neutral float-right" title="Development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Daniel Birman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>